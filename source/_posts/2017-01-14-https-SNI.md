---

title: HTTPS与SNI扩展，一个IP多个证书
date: 2017-01-14 12:28:52
categories: HTTPS
comments: true

---

## 背景
在搭建支持HTTPS的前端代理服务器时候，通常会遇到让人头痛的证书问题。根据HTTPS的工作原理，浏览器在访问一个HTTPS站点时，先与服务器建立SSL连接，建立连接的第一步就是请求服务器的证书。而服务器在发送证书的时候，是不知道浏览器访问的是哪个域名的，所以不能根据不同域名发送不同的证书。

## SNI
SNI（服务器名称指示，Server Name Indication）允许一个IP地址上多个域名安装多张证书，是为了解决一个服务器使用多个域名和证书的SSL/TLS扩展。一句话简述它的工作原理就是，在连接到服务器建立SSL连接之前先通过 Client Hello 中的 SNI 扩展拿到用户要访问网站的 Server Name，进而发送与之匹配的证书，顺利完成 SSL 握手，这样服务器根据这个域名返回一个合适的证书。目前，大多数操作系统和浏览器都已经很好地支持SNI扩展。

![](http://ojrccmq7z.bkt.clouddn.com/sni_loadbalancing.png)

Github上有一个小巧的支持SNI的代理服务器，https://github.com/dlundquist/HTTPS-SNI-Proxy

## SNI 应用
Linux中主要的网络交互工具，curl 7.18.1+ & openssl 0.9.8j+ 可以支持SNI，CentOS6.5及以下都是curl 7.15 不支持SNI，curl 7.21.3 又支持了–resolve 参数，可以直接定位到IP地址进行访问，对于一个域名有多个部署节点的服务来说，这个参数可以定向的访问某个设备。基本语法为：

```bash
Example:
   curl -k -I --resolve www.example.com:80:192.0.2.1 https://www.example.com/index.html
```
WireShark抓包验证SNI

使用curl7.15 （不支持SNI）抓包结果：
![](http://ojrccmq7z.bkt.clouddn.com/20161122224637862.jpeg)

使用curl7.43（支持SNI）抓包结果：
![](http://ojrccmq7z.bkt.clouddn.com/20161122224658907.jpeg)